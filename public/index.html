<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§¤ì¶œì§€í‚´ì´ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
    }

    body.output-mode {
      background: linear-gradient(135deg, #2e1a1a 0%, #3e1616 100%);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: #888;
      font-size: 14px;
    }

    /* ëª¨ë“œ í† ê¸€ */
    .mode-toggle {
      display: flex;
      background: #252540;
      border-radius: 16px;
      padding: 8px;
      margin-bottom: 24px;
    }

    body.output-mode .mode-toggle {
      background: #402525;
    }

    .mode-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      background: transparent;
      color: #666;
    }

    .mode-btn.active {
      color: #fff;
    }

    .mode-btn.auto-btn.active {
      background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
    }

    .mode-btn.input-btn.active {
      background: linear-gradient(135deg, #065f46 0%, #047857 100%);
    }

    .mode-btn.output-btn.active {
      background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%);
    }

    .mode-btn:hover:not(.active) {
      color: #999;
    }

    .scan-box {
      background: #252540;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
    }

    body.output-mode .scan-box {
      background: #402525;
    }

    .input-group {
      position: relative;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }

    .input-group input {
      width: 100%;
      padding: 16px 20px;
      font-size: 24px;
      border: 2px solid #3a3a5a;
      border-radius: 12px;
      background: #1a1a2e;
      color: #fff;
      text-align: center;
      letter-spacing: 4px;
      transition: border-color 0.2s;
    }

    body.output-mode .input-group input {
      background: #2e1a1a;
      border-color: #5a3a3a;
    }

    .input-group input:focus {
      outline: none;
      border-color: #6366f1;
    }

    body.output-mode .input-group input:focus {
      border-color: #ef4444;
    }

    .input-group input::placeholder {
      color: #555;
      letter-spacing: normal;
    }

    .quantity-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 20px;
    }

    .quantity-btn {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: none;
      background: #3a3a5a;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: background 0.2s;
    }

    body.output-mode .quantity-btn {
      background: #5a3a3a;
    }

    .quantity-btn:hover {
      background: #4a4a6a;
    }

    body.output-mode .quantity-btn:hover {
      background: #6a4a4a;
    }

    .quantity-display {
      font-size: 32px;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
    }

    .result-box {
      background: #252540;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.output-mode .result-box {
      background: #402525;
    }

    .result-box.success {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
    }

    .result-box.success.output {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    }

    .result-box.error {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    }

    .result-content {
      text-align: center;
    }

    .result-content .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .result-content .item-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .result-content .detail {
      font-size: 18px;
      color: rgba(255,255,255,0.8);
    }

    .result-content .message {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
    }

    .waiting {
      color: #666;
      font-size: 16px;
    }

    .history-box {
      background: #252540;
      border-radius: 16px;
      padding: 24px;
    }

    body.output-mode .history-box {
      background: #402525;
    }

    .history-box h3 {
      font-size: 16px;
      color: #888;
      margin-bottom: 16px;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #3a3a5a;
    }

    body.output-mode .history-item {
      border-bottom-color: #5a3a3a;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item .name {
      font-weight: 500;
    }

    .history-item .qty {
      font-weight: bold;
    }

    .history-item .qty.input {
      color: #22c55e;
    }

    .history-item .qty.output {
      color: #ef4444;
    }

    .history-item .time {
      font-size: 12px;
      color: #666;
    }

    .empty-history {
      color: #555;
      text-align: center;
      padding: 20px;
    }

    /* ëª¨ë“œ í‘œì‹œ ë°°ì§€ */
    .mode-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 8px;
    }

    .mode-badge.auto {
      background: #4338ca;
      color: #fff;
    }

    .mode-badge.input {
      background: #065f46;
      color: #fff;
    }

    .mode-badge.output {
      background: #991b1b;
      color: #fff;
    }

    /* ìŠ¤ìº” íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes scanPulse {
      0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
      100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }

    @keyframes scanPulseRed {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .scanning {
      animation: scanPulse 0.5s ease-out;
    }

    body.output-mode .scanning {
      animation: scanPulseRed 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“¦ ë§¤ì¶œì§€í‚´ì´</h1>
      <p>ë°”ì½”ë“œ ìŠ¤ìºë„ˆ <span class="mode-badge input" id="modeBadge">ì…ê³ </span></p>
    </div>

    <!-- ëª¨ë“œ í† ê¸€ -->
    <div class="mode-toggle">
      <button class="mode-btn auto-btn active" onclick="setMode('auto')">
        ğŸ”„ ìë™
      </button>
      <button class="mode-btn input-btn" onclick="setMode('input')">
        ğŸ“¥ ì…ê³ 
      </button>
      <button class="mode-btn output-btn" onclick="setMode('output')">
        ğŸ“¤ ì¶œê³ 
      </button>
    </div>

    <div class="scan-box">
      <div class="input-group">
        <label id="scanLabel">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš” (ì…ê³ )</label>
        <input
          type="text"
          id="barcodeInput"
          placeholder="ë°”ì½”ë“œ ëŒ€ê¸° ì¤‘..."
          autofocus
        >
      </div>

      <div class="quantity-row">
        <button class="quantity-btn" onclick="changeQuantity(-1)">âˆ’</button>
        <div class="quantity-display" id="quantityDisplay">1</div>
        <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
      </div>
    </div>

    <div class="result-box" id="resultBox">
      <div class="waiting">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>

    <div class="history-box">
      <h3>ğŸ“‹ ìŠ¤ìº” ì´ë ¥</h3>
      <div class="history-list" id="historyList">
        <div class="empty-history">ìŠ¤ìº” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>
    </div>
  </div>

  <script>
    const barcodeInput = document.getElementById('barcodeInput');
    const resultBox = document.getElementById('resultBox');
    const historyList = document.getElementById('historyList');
    const quantityDisplay = document.getElementById('quantityDisplay');
    const modeBadge = document.getElementById('modeBadge');
    const scanLabel = document.getElementById('scanLabel');

    let quantity = 1;
    let history = [];
    let debounceTimer = null;
    let currentMode = 'auto'; // 'auto', 'input', ë˜ëŠ” 'output'

    // ëª¨ë“œ í…ìŠ¤íŠ¸ ë§µ
    const modeText = {
      auto: 'ìë™',
      input: 'ì…ê³ ',
      output: 'ì¶œê³ '
    };

    // ëª¨ë“œ ë³€ê²½
    function setMode(mode) {
      currentMode = mode;

      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.mode-btn.${mode}-btn`).classList.add('active');

      // ë°°ì§€ ë³€ê²½
      modeBadge.textContent = modeText[mode];
      modeBadge.className = `mode-badge ${mode}`;

      // ë¼ë²¨ ë³€ê²½
      if (mode === 'auto') {
        scanLabel.textContent = 'ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš” (ìë™ ê°ì§€)';
      } else {
        scanLabel.textContent = `ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš” (${modeText[mode]})`;
      }

      // ë°°ê²½ìƒ‰ ë³€ê²½
      document.body.classList.remove('output-mode', 'auto-mode');
      if (mode === 'output') {
        document.body.classList.add('output-mode');
      } else if (mode === 'auto') {
        document.body.classList.add('auto-mode');
      }

      // í¬ì»¤ìŠ¤ ìœ ì§€
      barcodeInput.focus();
    }

    // ìˆ˜ëŸ‰ ë³€ê²½
    function changeQuantity(delta) {
      quantity = Math.max(1, Math.min(99, quantity + delta));
      quantityDisplay.textContent = quantity;
    }

    // WebSocket ëª¨ë“œ í”Œë˜ê·¸ (Global Key Listener ì‚¬ìš© ì‹œ)
    let useWebSocketMode = false;

    // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ìš©
    let lastProcessedBarcode = '';
    let lastProcessedTime = 0;

    // ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬ (ì…ë ¥ì°½ - WebSocket ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
    barcodeInput.addEventListener('input', (e) => {
      // WebSocket ëª¨ë“œë©´ ì…ë ¥ì°½ ì´ë²¤íŠ¸ ë¬´ì‹œ (Global Key Listenerê°€ ì²˜ë¦¬)
      if (useWebSocketMode) {
        e.target.value = '';
        return;
      }

      clearTimeout(debounceTimer);

      // ë°”ì½”ë“œ ìŠ¤ìºë„ˆëŠ” ë¹ ë¥´ê²Œ ì…ë ¥ í›„ Enter ë˜ëŠ” ì ì‹œ ë©ˆì¶¤
      debounceTimer = setTimeout(() => {
        const barcode = e.target.value.trim();
        if (barcode.length >= 8) { // ìµœì†Œ ë°”ì½”ë“œ ê¸¸ì´
          processBarcode(barcode);
        }
      }, 100);
    });

    // Enter í‚¤ë¡œë„ ì²˜ë¦¬ (WebSocket ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
    barcodeInput.addEventListener('keydown', (e) => {
      // WebSocket ëª¨ë“œë©´ ì…ë ¥ì°½ ì´ë²¤íŠ¸ ë¬´ì‹œ
      if (useWebSocketMode) {
        if (e.key === 'Enter') {
          e.target.value = '';
        }
        return;
      }

      if (e.key === 'Enter') {
        clearTimeout(debounceTimer);
        const barcode = e.target.value.trim();
        if (barcode) {
          processBarcode(barcode);
        }
      }
    });

    // ë°”ì½”ë“œ ì²˜ë¦¬
    async function processBarcode(barcode) {
      // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ (ê°™ì€ ë°”ì½”ë“œ 1ì´ˆ ì´ë‚´ ì¬ì²˜ë¦¬ ë°©ì§€)
      const now = Date.now();
      if (barcode === lastProcessedBarcode && (now - lastProcessedTime) < 1000) {
        console.log('[SKIP] ì¤‘ë³µ ë°”ì½”ë“œ ë¬´ì‹œ:', barcode);
        barcodeInput.value = '';
        return;
      }
      lastProcessedBarcode = barcode;
      lastProcessedTime = now;

      barcodeInput.classList.add('scanning');
      setTimeout(() => barcodeInput.classList.remove('scanning'), 500);

      try {
        // ìë™ ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ë³¸ê°’ 'input'ì„ ë³´ë‚´ê³ , ì„œë²„ì—ì„œ ì ‘ë‘ì‚¬ë¡œ íŒë‹¨
        const modeToSend = currentMode === 'auto' ? 'input' : currentMode;

        const response = await fetch('/api/scan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode, quantity, mode: modeToSend })
        });

        const result = await response.json();

        if (result.success) {
          showResult('success', result);
          addToHistory(result);
          playSound('success');
        } else {
          showResult('error', result);
          playSound('error');
        }
      } catch (error) {
        showResult('error', { message: 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜' });
        playSound('error');
      }

      // ì…ë ¥ ì´ˆê¸°í™”
      barcodeInput.value = '';
      barcodeInput.focus();
    }

    // ê²°ê³¼ í‘œì‹œ
    function showResult(type, result) {
      const isOutput = result.mode === 'output';
      resultBox.className = `result-box ${type}${isOutput ? ' output' : ''}`;

      if (type === 'success') {
        const changeText = result.change > 0 ? `+${result.change}` : result.change;
        const icon = isOutput ? 'ğŸ“¤' : 'ğŸ“¥';
        resultBox.innerHTML = `
          <div class="result-content">
            <div class="icon">${icon}</div>
            <div class="item-name">${result.item}</div>
            <div class="detail">${result.before} â†’ ${result.after} ${result.unit} (${changeText})</div>
          </div>
        `;
      } else {
        resultBox.innerHTML = `
          <div class="result-content">
            <div class="icon">âŒ</div>
            <div class="message">${result.message}</div>
            ${result.barcode ? `<div class="detail" style="margin-top:8px;font-size:14px;color:#999;">ë°”ì½”ë“œ: ${result.barcode}</div>` : ''}
          </div>
        `;
      }
    }

    // ì´ë ¥ ì¶”ê°€
    function addToHistory(result) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      const changeText = result.change > 0 ? `+${result.change}` : result.change;

      history.unshift({
        name: result.item,
        qty: changeText,
        mode: result.mode,
        time: timeStr
      });

      // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
      history = history.slice(0, 10);

      renderHistory();
    }

    // ì´ë ¥ ë Œë”ë§
    function renderHistory() {
      if (history.length === 0) {
        historyList.innerHTML = '<div class="empty-history">ìŠ¤ìº” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      historyList.innerHTML = history.map(item => `
        <div class="history-item">
          <div>
            <div class="name">${item.name}</div>
            <div class="time">${item.time}</div>
          </div>
          <div class="qty ${item.mode}">${item.qty}</div>
        </div>
      `).join('');
    }

    // ì‚¬ìš´ë“œ ì¬ìƒ
    function playSound(type) {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'success') {
          oscillator.frequency.value = currentMode === 'output' ? 440 : 880;
          gainNode.gain.value = 0.1;
        } else {
          oscillator.frequency.value = 220;
          gainNode.gain.value = 0.1;
        }

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.1);
      } catch (e) {
        // ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨ ë¬´ì‹œ
      }
    }

    // í¬ì»¤ìŠ¤ ìœ ì§€
    document.addEventListener('click', () => {
      barcodeInput.focus();
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Tabìœ¼ë¡œ ëª¨ë“œ ì „í™˜
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        setMode(currentMode === 'input' ? 'output' : 'input');
      }
    });

    // ì´ˆê¸° í¬ì»¤ìŠ¤
    barcodeInput.focus();

    // ========================================
    // WebSocket ì—°ê²° - Global Key Listener ì§€ì›
    // ========================================
    let ws = null;
    let wsReconnectTimer = null;

    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);

      ws.onopen = () => {
        console.log('[WS] ì„œë²„ ì—°ê²°ë¨');
      };

      ws.onmessage = async (event) => {
        try {
          const data = JSON.parse(event.data);

          // ì„œë²„ ìƒíƒœ ë©”ì‹œì§€ - Global Key Listener ëª¨ë“œ í™•ì¸
          if (data.type === 'status') {
            if (data.mode === 'global-key-listener') {
              useWebSocketMode = true;
              console.log('[WS] Global Key Listener ëª¨ë“œ í™œì„±í™” - ì…ë ¥ì°½ ë¹„í™œì„±í™”');
              barcodeInput.placeholder = 'Global Key Listener ëª¨ë“œ';
              barcodeInput.value = '';
            }
            return;
          }

          if (data.type === 'barcode' && data.scanId) {
            // Global Key Listenerë¡œë¶€í„° ë°”ì½”ë“œ ìˆ˜ì‹ 
            console.log('[WS] ë°”ì½”ë“œ ìˆ˜ì‹ :', data.barcode);

            // ë°”ì½”ë“œ ì²˜ë¦¬
            await processBarcode(data.barcode);

            // ì„œë²„ì— ì²˜ë¦¬ ì™„ë£Œ ì•Œë¦¼ (ì„œë²„ê°€ ì¤‘ë³µ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡)
            ws.send(JSON.stringify({
              type: 'processed',
              scanId: data.scanId
            }));
          }
        } catch (e) {
          console.error('[WS] ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
        }
      };

      ws.onclose = () => {
        console.log('[WS] ì—°ê²° ëŠê¹€, 3ì´ˆ í›„ ì¬ì—°ê²°...');
        useWebSocketMode = false;
        barcodeInput.placeholder = 'ë°”ì½”ë“œ ëŒ€ê¸° ì¤‘...';
        wsReconnectTimer = setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (err) => {
        console.error('[WS] ì˜¤ë¥˜:', err);
      };
    }

    // WebSocket ì—°ê²° ì‹œì‘
    connectWebSocket();
  </script>
</body>
</html>
